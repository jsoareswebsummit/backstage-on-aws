
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="backstage service infrastructure">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.1">
    
    
      
        <title>Boostrap and Setup - backstage infrastructure</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bootstrapping-and-setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="backstage infrastructure" class="md-header__button md-logo" aria-label="backstage infrastructure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            backstage infrastructure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Boostrap and Setup
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="backstage infrastructure" class="md-nav__button md-logo" aria-label="backstage infrastructure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    backstage infrastructure
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pipelines/" class="md-nav__link">
        Pipelines Description
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../stack/" class="md-nav__link">
        Application Infrastructure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../settings/" class="md-nav__link">
        Settings and Config
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Boostrap and Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Boostrap and Setup
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-route53-hosted-zones" class="md-nav__link">
    Create a Route53 hosted zones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-acm-certs-optional" class="md-nav__link">
    Create ACM certs (optional)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-oauth-tokens" class="md-nav__link">
    Create Github OAuth Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-aws-integration-user-and-tokens" class="md-nav__link">
    Create AWS integration User and Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-a-secrets-in-aws-secrets-manager" class="md-nav__link">
    Store a secrets in AWS Secrets Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-github-app-secrets-files-in-secrets-manager" class="md-nav__link">
    Store Github-App secrets file(s) in Secrets Manager.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-ecr-repositories" class="md-nav__link">
    Create ECR repositories
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codestar-connections-and-notifications" class="md-nav__link">
    Codestar Connections and Notifications
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../deploy/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-route53-hosted-zones" class="md-nav__link">
    Create a Route53 hosted zones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-acm-certs-optional" class="md-nav__link">
    Create ACM certs (optional)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-oauth-tokens" class="md-nav__link">
    Create Github OAuth Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-aws-integration-user-and-tokens" class="md-nav__link">
    Create AWS integration User and Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-a-secrets-in-aws-secrets-manager" class="md-nav__link">
    Store a secrets in AWS Secrets Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-github-app-secrets-files-in-secrets-manager" class="md-nav__link">
    Store Github-App secrets file(s) in Secrets Manager.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-ecr-repositories" class="md-nav__link">
    Create ECR repositories
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codestar-connections-and-notifications" class="md-nav__link">
    Codestar Connections and Notifications
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="bootstrapping-and-setup">Bootstrapping and Setup</h1>
<p>There is a bit of manual bootstrapping in the deployment account required for the pipelines and stacks to succeed. 
This maybe mitigated with some automation scripting and added features to the cdk stacks. </p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#create-a-route53-hosted-zones">Create a Route53 hosted zones</a></li>
<li><a href="#create-acm-certs-optional">Create ACM certs (optional)</a></li>
<li><a href="#create-github-oauth-tokens">Create Github OAuth Tokens</a></li>
<li><a href="#create-aws-integration-user-and-tokens">Create AWS integration User and Tokens</a></li>
<li><a href="#store-a-secrets-in-aws-secrets-manager">Store a secrets in AWS Secrets Manager</a></li>
<li><a href="#store-github-app-secrets-files-in-secrets-manager">Store Github-App secrets file(s) in Secrets Manager.</a></li>
<li><a href="#create-ecr-repositories">Create ECR repositories</a></li>
<li><a href="#codestar-connections-and-notifications">Codestar Connections and Notifications</a></li>
</ul>
<h2 id="create-a-route53-hosted-zones">Create a Route53 hosted zones</h2>
<p>The cdk stack assumes a pre-existing domain name and hosted zone in route53 for each stage.
You must create manually a subdomain for each of the stages specified in route53. The stack will then associate that domain name with the application load balancer for that particular stage.</p>
<h2 id="create-acm-certs-optional">Create ACM certs (optional)</h2>
<p>If the stack does not find <code>ACM_ARN</code> defined in either the common configuration or the stage configurations it will try to create an ACM with the domain name specified for the stage.</p>
<h2 id="create-github-oauth-tokens">Create Github OAuth Tokens</h2>
<p>If you want to use Github auth as your backstage IDP, you will need to create an Oauth token to allow backstage to connect. This can only be done by an owner of the org, and is found under the org developer settings. Save the token id and secret for storage in AWS secrets manager. Each OAuth token depends on callbacks to the url for the application and so must be unique for each domain name of the application. So if you have multiple stages configured, you will need to create multiple OAuth applications and secrets. </p>
<h2 id="create-aws-integration-user-and-tokens">Create AWS integration User and Tokens</h2>
<p>The backstage app uses tokens for access to AWS services like techdocs as well as any aws based plugin, in theory it should be able to use the credentials attached to the ECS container via a role (similar to EC2 roles), but this is a recent development and hasnt been tested. Currently we use setting particular environment variables in the runtime environment of the container to give the sevice access to AWS resources. We created an integration user and group and attached policies to the group for that user. The access token and secret are stored in AWS Secrets Manager. 
The current polices allowed for the group we used are:
- ReadOnlyAccess</p>
<h2 id="store-a-secrets-in-aws-secrets-manager">Store a secrets in AWS Secrets Manager</h2>
<p>To give the backstage services access to 3rd party apis securely, we bootstrap aws secrets manager with the tokens created above and extract them at deploy time to inject in the infrastructure as environment variables</p>
<p>You will want to add the tokens created for Github auth and AWS auth into secret manager. The cdk stack will lookup those secrets and create new env vars detailed below and inject them into the container at runtime as the following variables:</p>
<ul>
<li>AUTH_GITHUB_CLIENT_ID --&gt; looks in the secret name stored in  <code>GITHUB_AUTH_SECRET_NAME</code> for a key name of 'id'</li>
<li>AUTH_GITHUB_CLIENT_SECRET --&gt; looks in the secret name stored in <code>GITHUB_AUTH_SECRET_NAME</code> for a key name of 'secret'</li>
<li>AWS_ACCESS_KEY_ID --&gt; looks in the secret name stored in <code>AWS_AUTH_SECRET_NAME</code> for a key name of 'id'</li>
<li>AWS_ACCESS_KEY_SECRET --&gt; looks in the secret name stored in <code>AWS_AUTH_SECRET_NAME</code> for a key name of 'secret'</li>
</ul>
<p>So we need to create secrets in secret manager with the following fields
  - Key: 'id' 
    - Value: token id
  - Key: 'secret'
    - Value: token secret</p>
<p>Further because the test instance and prod instance each have unique domain names we need separate github auth secrets configured for each environment. 
See <a href="../configs/env-config.yaml">env-config.yaml</a>, for examples of the github auth for each stage.</p>
<h2 id="store-github-app-secrets-files-in-secrets-manager">Store Github-App secrets file(s) in Secrets Manager.</h2>
<p>Instead of using personal access tokens for backstage access the github apis, we have configured the use of a github-app for each of the orgs in github that you want to connect to.  Use of these apps requires providing a crendential configuration file to backstage at run time. The file includes a full PEM certificate that makes it difficult to pass via environment variables, so we store the raw file in Secrets Manager (<a href="https://medium.com/@nilouferbustani/securing-ssh-private-keys-using-aws-secrets-manager-6d93537c1037">see example</a>) retrieve the contents in the app pipeline and write that to a file which is copied into the image during build. The ARNs for those secrets are loaded from the <code>env-config.yaml</code> file. </p>
<p>To create a new github-app you can use a utility in the backstage app with</p>
<pre><code class="language-bash">yarn backstage-cli create-github-app &lt;github-org&gt;
</code></pre>
<p>some permissions will need to be updated in Github on the app for the backstage to be able to execute all its actions, you can find those permissions under settings &gt; developer settings &gt; github-app. The following permissions are currently set in both orgs:</p>
<ul>
<li>actions (r/w)</li>
<li>administration (r/w)</li>
<li>contents (r/w)</li>
<li>issues (r/w)</li>
<li>metadata (r)</li>
<li>pages (r/w)</li>
<li>pull-requests (r/w)</li>
<li>workflows (r/w)</li>
<li>members (r)</li>
<li>email addresses (r)</li>
</ul>
<h2 id="create-ecr-repositories">Create ECR repositories</h2>
<p>The application pipeline will build and push to an ECR repository name in the <code>ECR_REPO_NAME</code> variable in <code>env-config.yaml</code>. The cdk stack will attempt to create this repo with the name set or with the <code>CONTAINER_NAME</code>. The app-pipeline will build the first image and push it succesfully, so you do not need to pre-build and pre-seed the repo with an image. </p>
<h2 id="codestar-connections-and-notifications">Codestar Connections and Notifications</h2>
<p>Both pipelines use a codestar connection to authenticate to github to watch for changes, as well as a codestar notification to push notifcations to slack via the AWS Chatbot integration. 
Each of these need to be setup in advance, at the time CDK did not support creation of these. 
The configuration file just needs the arn of each to provide to CDK stacks.</p>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../settings/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Settings and Config" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Settings and Config
            </div>
          </div>
        </a>
      
      
        
        <a href="../deploy/" class="md-footer__link md-footer__link--next" aria-label="Next: Deployment" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Deployment
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>